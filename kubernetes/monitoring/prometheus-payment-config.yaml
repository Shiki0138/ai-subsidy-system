# Prometheusè¨­å®š - æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ å°‚ç”¨ç›£è¦–
# Team D: Infrastructure & Monitoring
# Created: 2025-06-20
# Purpose: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰èª²é‡‘ãƒ¢ãƒ‡ãƒ«å®Ÿè£…ã«ãŠã‘ã‚‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®è©³ç´°ç›£è¦–

apiVersion: v1
kind: ConfigMap
metadata:
  name: prometheus-payment-config
  namespace: monitoring
  labels:
    app: prometheus
    component: payment-monitoring
    team: team-d
    created-by: "hybrid-billing-implementation"
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s
      external_labels:
        cluster: 'ai-subsidy-payment-cluster'
        team: 'team-d'

    rule_files:
      - "/etc/prometheus/rules/*.yml"

    alerting:
      alertmanagers:
        - static_configs:
            - targets:
              - alertmanager:9093

    scrape_configs:
      # æ±ºæ¸ˆAPIç›£è¦–ï¼ˆæœ€é«˜å„ªå…ˆåº¦ï¼‰
      - job_name: 'payment-api'
        scrape_interval: 5s
        scrape_timeout: 4s
        metrics_path: '/metrics'
        scheme: 'http'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['payment-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape]
            action: keep
            regex: true
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_path]
            action: replace
            target_label: __metrics_path__
            regex: (.+)
          - source_labels: [__address__, __meta_kubernetes_pod_annotation_prometheus_io_port]
            action: replace
            regex: ([^:]+)(?::\d+)?;(\d+)
            replacement: $1:$2
            target_label: __address__
          - action: labelmap
            regex: __meta_kubernetes_pod_label_(.+)
          - source_labels: [__meta_kubernetes_namespace]
            action: replace
            target_label: kubernetes_namespace
          - source_labels: [__meta_kubernetes_pod_name]
            action: replace
            target_label: kubernetes_pod_name
        metric_relabel_configs:
          # æ±ºæ¸ˆãƒ¡ãƒˆãƒªã‚¯ã‚¹ã®å„ªå…ˆä¿æŒ
          - source_labels: [__name__]
            regex: 'payment_.*'
            action: keep
          # é«˜ç²¾åº¦ã§ã®ãƒ‡ãƒ¼ã‚¿ä¿æŒ
          - source_labels: [__name__]
            regex: 'payment_(success_rate|latency|error_rate)'
            target_label: __tmp_priority__
            replacement: 'critical'

      # Stripe Webhookç›£è¦–
      - job_name: 'stripe-webhooks'
        scrape_interval: 10s
        scrape_timeout: 8s
        metrics_path: '/webhook/metrics'
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['payment-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: 'stripe-webhook-processor'
          - source_labels: [__meta_kubernetes_pod_annotation_prometheus_io_scrape_webhook]
            action: keep
            regex: true

      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–
      - job_name: 'postgres-payment'
        scrape_interval: 30s
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['payment-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: 'postgres-exporter'

      # Redisç›£è¦–
      - job_name: 'redis-payment'
        scrape_interval: 30s
        kubernetes_sd_configs:
          - role: pod
            namespaces:
              names: ['payment-system']
        relabel_configs:
          - source_labels: [__meta_kubernetes_pod_label_app]
            action: keep
            regex: 'redis-exporter'

      # ã‚¤ãƒ³ãƒ•ãƒ©ç›£è¦–
      - job_name: 'kubernetes-nodes'
        scrape_interval: 30s
        kubernetes_sd_configs:
          - role: node
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics

      # Kubeletç›£è¦–
      - job_name: 'kubernetes-kubelet'
        scrape_interval: 30s
        kubernetes_sd_configs:
          - role: node
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
          insecure_skip_verify: true
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - action: labelmap
            regex: __meta_kubernetes_node_label_(.+)
          - target_label: __address__
            replacement: kubernetes.default.svc:443
          - source_labels: [__meta_kubernetes_node_name]
            regex: (.+)
            target_label: __metrics_path__
            replacement: /api/v1/nodes/${1}/proxy/metrics

      # Kubernetes API Serverç›£è¦–
      - job_name: 'kubernetes-apiservers'
        scrape_interval: 30s
        kubernetes_sd_configs:
          - role: endpoints
            namespaces:
              names: ['default']
        scheme: https
        tls_config:
          ca_file: /var/run/secrets/kubernetes.io/serviceaccount/ca.crt
        bearer_token_file: /var/run/secrets/kubernetes.io/serviceaccount/token
        relabel_configs:
          - source_labels: [__meta_kubernetes_namespace, __meta_kubernetes_service_name, __meta_kubernetes_endpoint_port_name]
            action: keep
            regex: default;kubernetes;https

  payment_alerts.yml: |
    groups:
      - name: payment_system_critical
        interval: 15s
        rules:
          # æ±ºæ¸ˆæˆåŠŸç‡ï¼ˆ99.5%é–¾å€¤ï¼‰- æœ€é‡è¦æŒ‡æ¨™
          - alert: PaymentSuccessRateCritical
            expr: |
              (
                sum(rate(payment_transactions_total{status="success"}[2m])) /
                sum(rate(payment_transactions_total[2m]))
              ) * 100 < 99.5
            for: 1m
            labels:
              severity: critical
              team: team-d
              impact: "revenue-loss"
              priority: "P0"
            annotations:
              summary: "ğŸš¨ æ±ºæ¸ˆæˆåŠŸç‡ãŒ99.5%ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ"
              description: |
                éå»2åˆ†é–“ã®æ±ºæ¸ˆæˆåŠŸç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ç›®æ¨™å€¤: 99.5%
                ç¾åœ¨å€¤: {{ $value | humanizePercentage }}
                å¤±æ•—æ•°: {{ with query "sum(rate(payment_transactions_total{status=\"failed\"}[2m])) * 120" }}{{ . | first | value | humanize }}{{ end }} ä»¶/2åˆ†
              user_impact: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆã‚’å®Œäº†ã§ãã¾ã›ã‚“ã€‚åç›Šã«ç›´æ¥å½±éŸ¿ã—ã¾ã™ã€‚"
              runbook_url: "https://docs.ai-subsidy.com/runbooks/payment-failure"
              action_required: "å³åº§ã«æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®å¥å…¨æ€§ã‚’ç¢ºèªã—ã¦ãã ã•ã„"

          # æ±ºæ¸ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ï¼ˆ3ç§’é–¾å€¤ï¼‰
          - alert: PaymentLatencyCritical
            expr: |
              histogram_quantile(0.99, 
                sum(rate(payment_request_duration_seconds_bucket[2m])) by (le)
              ) > 3
            for: 1m
            labels:
              severity: critical
              team: team-d
              impact: "user-experience"
              priority: "P0"
            annotations:
              summary: "ğŸŒ æ±ºæ¸ˆå‡¦ç†ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ3ç§’ã‚’è¶…ãˆã¾ã—ãŸ"
              description: |
                99%ileãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ {{ $value }} ç§’ã§ã™ã€‚
                ç›®æ¨™å€¤: 3ç§’ä»¥å†…
                ç¾åœ¨å€¤: {{ $value }} ç§’
                å¹³å‡ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·: {{ with query "avg(rate(payment_request_duration_seconds_sum[2m]) / rate(payment_request_duration_seconds_count[2m]))" }}{{ . | first | value | printf "%.2f" }}{{ end }} ç§’
              user_impact: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±ºæ¸ˆä½“é¨“ãŒè‘—ã—ãæ‚ªåŒ–ã—ã¦ã„ã¾ã™"
              action_required: "ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ã¨ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ‘ãƒ•ã‚©ãƒ¼ãƒãƒ³ã‚¹ã‚’ç¢ºèª"

          # Webhookå‡¦ç†å¤±æ•—ï¼ˆ99.9%é–¾å€¤ï¼‰
          - alert: WebhookProcessingCritical
            expr: |
              (
                sum(rate(stripe_webhook_processed_total{status="success"}[2m])) /
                sum(rate(stripe_webhook_processed_total[2m]))
              ) * 100 < 99.9
            for: 1m
            labels:
              severity: critical
              team: team-d
              impact: "data-consistency"
              priority: "P0"
            annotations:
              summary: "ğŸ”— Stripe Webhookå‡¦ç†ã®æˆåŠŸç‡ãŒä½ä¸‹"
              description: |
                Webhookå‡¦ç†æˆåŠŸç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ç›®æ¨™å€¤: 99.9%
                ç¾åœ¨å€¤: {{ $value | humanizePercentage }}
                å¾…æ©Ÿä¸­: {{ with query "sum(stripe_webhook_queue_size)" }}{{ . | first | value | humanize }}{{ end }} ä»¶
              user_impact: "æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã«é…å»¶ãŒç™ºç”Ÿã—ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«æ··ä¹±ã‚’ä¸ãˆã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"
              action_required: "Webhookå‡¦ç†ã‚·ã‚¹ãƒ†ãƒ ã¨Stripe APIã®æ¥ç¶šã‚’ç¢ºèª"

          # æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ åœæ­¢
          - alert: PaymentSystemDown
            expr: |
              up{job="payment-api"} == 0
            for: 30s
            labels:
              severity: critical
              team: team-d
              impact: "system-outage"
              priority: "P0"
            annotations:
              summary: "ğŸ›‘ æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ãŒåœæ­¢ã—ã¦ã„ã¾ã™"
              description: "æ±ºæ¸ˆAPIã‚µãƒ¼ãƒ“ã‚¹ã«ã‚¢ã‚¯ã‚»ã‚¹ã§ãã¾ã›ã‚“"
              user_impact: "ã™ã¹ã¦ã®æ±ºæ¸ˆå‡¦ç†ãŒåœæ­¢ã—ã¦ã„ã¾ã™"
              action_required: "ã‚·ã‚¹ãƒ†ãƒ ã®å³åº§ãªå¾©æ—§ãŒå¿…è¦ã§ã™"

      - name: payment_system_warning
        interval: 30s
        rules:
          # æ±ºæ¸ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡
          - alert: PaymentTimeoutRateHigh
            expr: |
              (
                sum(rate(payment_transactions_total{status="timeout"}[5m])) /
                sum(rate(payment_transactions_total[5m]))
              ) * 100 > 1
            for: 2m
            labels:
              severity: warning
              team: team-d
              impact: "user-experience"
              priority: "P1"
            annotations:
              summary: "â° æ±ºæ¸ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ç›®æ¨™å€¤: 1%ä»¥ä¸‹
                5åˆ†é–“ã®ç·æ±ºæ¸ˆæ•°: {{ with query "sum(rate(payment_transactions_total[5m])) * 300" }}{{ . | first | value | humanize }}{{ end }} ä»¶
              user_impact: "æ±ºæ¸ˆå®Œäº†ã¾ã§ã®æ™‚é–“ãŒé•·ããªã£ã¦ã„ã¾ã™"

          # é«˜ã„ãƒªãƒˆãƒ©ã‚¤ç‡
          - alert: PaymentRetryRateHigh
            expr: |
              (
                sum(rate(payment_retries_total[5m])) /
                sum(rate(payment_transactions_total[5m]))
              ) * 100 > 5
            for: 3m
            labels:
              severity: warning
              team: team-d
              impact: "system-stability"
              priority: "P2"
            annotations:
              summary: "ğŸ”„ æ±ºæ¸ˆãƒªãƒˆãƒ©ã‚¤ç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                ãƒªãƒˆãƒ©ã‚¤ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ç›®æ¨™å€¤: 5%ä»¥ä¸‹
                å¤–éƒ¨ã‚µãƒ¼ãƒ“ã‚¹ï¼ˆStripeï¼‰ã®å®‰å®šæ€§ã«å•é¡ŒãŒã‚ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
              action_required: "Stripe APIã®çŠ¶æ…‹ã¨ãƒãƒƒãƒˆãƒ¯ãƒ¼ã‚¯æ¥ç¶šã‚’ç¢ºèª"

          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«æ¯æ¸‡
          - alert: DatabaseConnectionPoolHigh
            expr: |
              (
                sum(postgresql_connections_active) /
                sum(postgresql_connections_max)
              ) * 100 > 80
            for: 5m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
              priority: "P2"
            annotations:
              summary: "ğŸ—„ï¸ ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šãƒ—ãƒ¼ãƒ«ã®ä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                æ¥ç¶šãƒ—ãƒ¼ãƒ«ä½¿ç”¨ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ã‚¢ã‚¯ãƒ†ã‚£ãƒ–æ¥ç¶š: {{ with query "sum(postgresql_connections_active)" }}{{ . | first | value | humanize }}{{ end }}
                æœ€å¤§æ¥ç¶šæ•°: {{ with query "sum(postgresql_connections_max)" }}{{ . | first | value | humanize }}{{ end }}

      - name: infrastructure_monitoring
        interval: 60s
        rules:
          # ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡ç›£è¦–
          - alert: HighCPUUsage
            expr: |
              (
                100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)
              ) > 80
            for: 5m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
              priority: "P2"
            annotations:
              summary: "ğŸ’» CPUä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: "ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ {{ $labels.instance }} ã®CPUä½¿ç”¨ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™"

          - alert: HighMemoryUsage
            expr: |
              (
                1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)
              ) * 100 > 85
            for: 5m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
              priority: "P2"
            annotations:
              summary: "ğŸ§  ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹ {{ $labels.instance }} ã®ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™
                åˆ©ç”¨å¯èƒ½ãƒ¡ãƒ¢ãƒª: {{ with query "node_memory_MemAvailable_bytes{instance=\"" }}{{ $labels.instance }}{{ "\"}" }}{{ . | first | value | humanizeBytes }}{{ end }}

          # ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡
          - alert: HighDiskUsage
            expr: |
              (
                1 - (node_filesystem_avail_bytes / node_filesystem_size_bytes)
              ) * 100 > 85
            for: 10m
            labels:
              severity: warning
              team: team-d
              impact: "storage"
              priority: "P2"
            annotations:
              summary: "ğŸ’¾ ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                {{ $labels.instance }} ã® {{ $labels.mountpoint }} ãƒ‡ã‚£ã‚¹ã‚¯ä½¿ç”¨ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™
                åˆ©ç”¨å¯èƒ½å®¹é‡: {{ with query "node_filesystem_avail_bytes{instance=\"" }}{{ $labels.instance }}{{ "\",mountpoint=\"" }}{{ $labels.mountpoint }}{{ "\"}" }}{{ . | first | value | humanizeBytes }}{{ end }}

      - name: security_monitoring
        interval: 30s
        rules:
          # ä¸å¯©ãªæ±ºæ¸ˆãƒ‘ã‚¿ãƒ¼ãƒ³
          - alert: SuspiciousPaymentPattern
            expr: |
              sum(rate(payment_transactions_total{amount_range="high"}[1m])) by (user_id) > 10
            for: 1m
            labels:
              severity: warning
              team: team-d
              impact: "security"
              priority: "P1"
            annotations:
              summary: "ğŸš¨ ä¸å¯©ãªæ±ºæ¸ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œçŸ¥"
              description: |
                ãƒ¦ãƒ¼ã‚¶ãƒ¼ {{ $labels.user_id }} ãŒ1åˆ†é–“ã« {{ $value }} å›ã®é«˜é¡æ±ºæ¸ˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚
                é€šå¸¸ã®æ±ºæ¸ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‹ã‚‰å¤§ããé€¸è„±ã—ã¦ã„ã¾ã™ã€‚
              action_required: "ã‚¢ã‚«ã‚¦ãƒ³ãƒˆã®ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£çŠ¶æ³ã‚’ç¢ºèªã—ã€å¿…è¦ã«å¿œã˜ã¦ä¸€æ™‚åˆ¶é™ã‚’æ¤œè¨"

          # ç•°å¸¸ãªã‚¨ãƒ©ãƒ¼ç‡
          - alert: HighErrorRate
            expr: |
              (
                sum(rate(http_requests_total{status=~"5.."}[5m])) /
                sum(rate(http_requests_total[5m]))
              ) * 100 > 5
            for: 3m
            labels:
              severity: warning
              team: team-d
              impact: "system-stability"
              priority: "P1"
            annotations:
              summary: "âš ï¸ HTTPã‚¨ãƒ©ãƒ¼ç‡ãŒé«˜ã™ãã¾ã™"
              description: |
                5xxã‚¨ãƒ©ãƒ¼ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                ã‚·ã‚¹ãƒ†ãƒ ã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚

          # WAFãƒ–ãƒ­ãƒƒã‚¯ç‡ä¸Šæ˜‡
          - alert: HighWAFBlockRate
            expr: |
              (
                sum(rate(waf_blocked_requests_total[5m])) /
                sum(rate(waf_total_requests[5m]))
              ) * 100 > 10
            for: 3m
            labels:
              severity: warning
              team: team-d
              impact: "security"
              priority: "P1"
            annotations:
              summary: "ğŸ›¡ï¸ WAFãƒ–ãƒ­ãƒƒã‚¯ç‡ãŒä¸Šæ˜‡ã—ã¦ã„ã¾ã™"
              description: |
                WAFã«ã‚ˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ç‡ãŒ {{ $value | humanizePercentage }} ã§ã™ã€‚
                æ”»æ’ƒã‚’å—ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚
                éå»5åˆ†é–“ã®ãƒ–ãƒ­ãƒƒã‚¯æ•°: {{ with query "sum(rate(waf_blocked_requests_total[5m])) * 300" }}{{ . | first | value | humanize }}{{ end }} ä»¶

  recording_rules.yml: |
    groups:
      - name: payment_performance_recording
        interval: 15s
        rules:
          # æ±ºæ¸ˆæˆåŠŸç‡ï¼ˆé«˜é »åº¦è¨˜éŒ²ï¼‰
          - record: payment:success_rate:rate2m
            expr: |
              sum(rate(payment_transactions_total{status="success"}[2m])) /
              sum(rate(payment_transactions_total[2m])) * 100

          - record: payment:success_rate:rate5m
            expr: |
              sum(rate(payment_transactions_total{status="success"}[5m])) /
              sum(rate(payment_transactions_total[5m])) * 100

          # æ±ºæ¸ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·åˆ†å¸ƒ
          - record: payment:latency:p50:rate2m
            expr: |
              histogram_quantile(0.50, 
                sum(rate(payment_request_duration_seconds_bucket[2m])) by (le)
              )

          - record: payment:latency:p95:rate2m
            expr: |
              histogram_quantile(0.95, 
                sum(rate(payment_request_duration_seconds_bucket[2m])) by (le)
              )

          - record: payment:latency:p99:rate2m
            expr: |
              histogram_quantile(0.99, 
                sum(rate(payment_request_duration_seconds_bucket[2m])) by (le)
              )

          # æ±ºæ¸ˆé‡ï¼ˆRPMï¼‰
          - record: payment:transactions:rpm
            expr: |
              sum(rate(payment_transactions_total[1m])) * 60

          # æ±ºæ¸ˆæ–¹æ³•åˆ¥æˆåŠŸç‡
          - record: payment:success_rate_by_method:rate5m
            expr: |
              sum(rate(payment_transactions_total{status="success"}[5m])) by (payment_method) /
              sum(rate(payment_transactions_total[5m])) by (payment_method) * 100

      - name: infrastructure_recording
        interval: 30s
        rules:
          # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆ¥CPUä½¿ç”¨ç‡
          - record: instance:cpu_usage:rate5m
            expr: |
              100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100)

          # ã‚¤ãƒ³ã‚¹ã‚¿ãƒ³ã‚¹åˆ¥ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡
          - record: instance:memory_usage:ratio
            expr: |
              (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100

          # ã‚¢ãƒ—ãƒªã‚±ãƒ¼ã‚·ãƒ§ãƒ³åˆ¥ãƒªã‚¯ã‚¨ã‚¹ãƒˆç‡
          - record: app:http_requests:rate5m
            expr: |
              sum(rate(http_requests_total[5m])) by (app, method, status)

---
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-payment-config
  namespace: monitoring
  labels:
    app: alertmanager
    component: payment-monitoring
    team: team-d
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.ai-subsidy.com:587'
      smtp_from: 'alerts@ai-subsidy.com'
      smtp_auth_username: 'alerts@ai-subsidy.com'
      smtp_auth_password_file: '/etc/alertmanager/secrets/smtp_password'
      resolve_timeout: 5m

    templates:
      - '/etc/alertmanager/templates/*.tmpl'

    route:
      group_by: ['alertname', 'cluster', 'service']
      group_wait: 30s
      group_interval: 2m
      repeat_interval: 12h
      receiver: 'team-d-default'
      routes:
        # æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ é‡è¦ã‚¢ãƒ©ãƒ¼ãƒˆï¼ˆå³åº§ã«é€šçŸ¥ï¼‰
        - match_re:
            alertname: 'Payment.*Critical|PaymentSystemDown'
          receiver: 'payment-critical'
          group_wait: 0s
          repeat_interval: 2m
          continue: true
        
        # ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ
        - match:
            impact: security
          receiver: 'security-alerts'
          group_wait: 30s
          repeat_interval: 30m
        
        # ãƒãƒ¼ãƒ Då‘ã‘ã‚¢ãƒ©ãƒ¼ãƒˆ
        - match:
            team: team-d
          receiver: 'team-d-alerts'
          group_wait: 1m
          repeat_interval: 4h

    inhibit_rules:
      # PaymentSystemDownãŒç™ºç”Ÿã—ãŸå ´åˆã€ä»–ã®æ±ºæ¸ˆé–¢é€£ã‚¢ãƒ©ãƒ¼ãƒˆã‚’æŠ‘åˆ¶
      - source_match:
          alertname: PaymentSystemDown
        target_match_re:
          alertname: 'Payment.*'
        equal: ['cluster']
      
      # é‡è¦åº¦ã®é«˜ã„ã‚¢ãƒ©ãƒ¼ãƒˆãŒå‡ºã¦ã„ã‚‹å ´åˆã€ä½ã„é‡è¦åº¦ã‚’æŠ‘åˆ¶
      - source_match:
          severity: critical
        target_match:
          severity: warning
        equal: ['alertname', 'cluster', 'service']

    receivers:
      - name: 'team-d-default'
        email_configs:
          - to: 'team-d@ai-subsidy.com'
            subject: '[Team D] {{ .Status | toUpper }} - {{ .GroupLabels.alertname }}'
            html: |
              <h2>ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</h2>
              <p><strong>ã‚¹ãƒ†ãƒ¼ã‚¿ã‚¹:</strong> {{ .Status | toUpper }}</p>
              <p><strong>ã‚°ãƒ«ãƒ¼ãƒ—:</strong> {{ .GroupLabels.alertname }}</p>
              
              {{ range .Alerts }}
              <hr>
              <h3>{{ .Annotations.summary }}</h3>
              <p><strong>è©³ç´°:</strong> {{ .Annotations.description }}</p>
              <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿:</strong> {{ .Annotations.user_impact }}</p>
              <p><strong>ç™ºç”Ÿæ™‚åˆ»:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}</p>
              {{ if .Annotations.runbook_url }}
              <p><strong>å¯¾å¿œæ‰‹é †:</strong> <a href="{{ .Annotations.runbook_url }}">{{ .Annotations.runbook_url }}</a></p>
              {{ end }}
              {{ end }}

      - name: 'payment-critical'
        email_configs:
          - to: 'critical@ai-subsidy.com'
            subject: '[CRITICAL] æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ é‡è¦ã‚¢ãƒ©ãƒ¼ãƒˆ - {{ .GroupLabels.alertname }}'
            html: |
              <h1 style="color: red;">ğŸš¨ ç·Šæ€¥: æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ é‡è¦ã‚¢ãƒ©ãƒ¼ãƒˆ</h1>
              {{ range .Alerts }}
              <h2>{{ .Annotations.summary }}</h2>
              <p><strong>è©³ç´°:</strong> {{ .Annotations.description }}</p>
              <p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿:</strong> {{ .Annotations.user_impact }}</p>
              <p><strong>è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> {{ .Annotations.action_required }}</p>
              <p><strong>ç™ºç”Ÿæ™‚åˆ»:</strong> {{ .StartsAt.Format "2006-01-02 15:04:05 JST" }}</p>
              {{ end }}
        
        slack_configs:
          - api_url_file: '/etc/alertmanager/secrets/slack_webhook'
            channel: '#team-d-critical'
            title: 'ğŸš¨ CRITICAL: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *{{ .Annotations.summary }}*
              
              *è©³ç´°:* {{ .Annotations.description }}
              *ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿:* {{ .Annotations.user_impact }}
              *è¦æ±‚ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:* {{ .Annotations.action_required }}
              
              *ç™ºç”Ÿæ™‚åˆ»:* {{ .StartsAt.Format "15:04:05" }}
              {{ if .Annotations.runbook_url }}*å¯¾å¿œæ‰‹é †:* {{ .Annotations.runbook_url }}{{ end }}
              {{ end }}
            
        pagerduty_configs:
          - service_key_file: '/etc/alertmanager/secrets/pagerduty_key'
            description: '{{ .GroupLabels.alertname }}: {{ range .Alerts }}{{ .Annotations.summary }}{{ end }}'
            details:
              firing: '{{ .Alerts.Firing | len }}'
              resolved: '{{ .Alerts.Resolved | len }}'
              user_impact: '{{ range .Alerts }}{{ .Annotations.user_impact }}{{ end }}'

      - name: 'team-d-alerts'
        email_configs:
          - to: 'team-d@ai-subsidy.com'
            subject: '[Team D] {{ .Status | toUpper }} - {{ .GroupLabels.alertname }}'
            html: |
              <h2>Team D ã‚¢ãƒ©ãƒ¼ãƒˆé€šçŸ¥</h2>
              {{ range .Alerts }}
              <h3>{{ .Annotations.summary }}</h3>
              <p>{{ .Annotations.description }}</p>
              {{ if .Annotations.user_impact }}<p><strong>ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿:</strong> {{ .Annotations.user_impact }}</p>{{ end }}
              {{ end }}
        
        slack_configs:
          - api_url_file: '/etc/alertmanager/secrets/slack_webhook'
            channel: '#team-d-alerts'
            title: '{{ .Status | toUpper }}: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              {{ .Annotations.summary }}
              {{ .Annotations.description }}
              {{ end }}

      - name: 'security-alerts'
        email_configs:
          - to: 'security@ai-subsidy.com'
            subject: '[SECURITY] {{ .GroupLabels.alertname }}'
            html: |
              <h2 style="color: orange;">ğŸ›¡ï¸ ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£ã‚¢ãƒ©ãƒ¼ãƒˆ</h2>
              {{ range .Alerts }}
              <h3>{{ .Annotations.summary }}</h3>
              <p>{{ .Annotations.description }}</p>
              {{ if .Annotations.action_required }}<p><strong>æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:</strong> {{ .Annotations.action_required }}</p>{{ end }}
              {{ end }}
        
        slack_configs:
          - api_url_file: '/etc/alertmanager/secrets/slack_webhook'
            channel: '#security-alerts'
            title: 'ğŸ›¡ï¸ Security Alert: {{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              *{{ .Annotations.summary }}*
              {{ .Annotations.description }}
              {{ if .Annotations.action_required }}*æ¨å¥¨ã‚¢ã‚¯ã‚·ãƒ§ãƒ³:* {{ .Annotations.action_required }}{{ end }}
              {{ end }}