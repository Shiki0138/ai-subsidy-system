# æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ å°‚ç”¨ç›£è¦–è¨­å®š
# Team D: Infrastructure & Monitoring
# Created: 2025-06-20
# Purpose: ãƒã‚¤ãƒ–ãƒªãƒƒãƒ‰èª²é‡‘ãƒ¢ãƒ‡ãƒ«å®Ÿè£…ã«ãŠã‘ã‚‹æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®ä¿¡é ¼æ€§ä¿è¨¼

apiVersion: v1
kind: ConfigMap
metadata:
  name: payment-monitoring-config
  namespace: ai-subsidy-system
  labels:
    component: payment-monitoring
    team: team-d
    created-by: "hybrid-billing-implementation"
data:
  prometheus.yml: |
    global:
      scrape_interval: 15s
      evaluation_interval: 15s

    rule_files:
      - "payment_alerts.yml"
      - "security_alerts.yml"

    scrape_configs:
      # æ±ºæ¸ˆAPIç›£è¦–
      - job_name: 'payment-api'
        scrape_interval: 5s
        metrics_path: '/metrics'
        static_configs:
          - targets: ['payment-service:8080']
        scrape_timeout: 4s

      # Stripe Webhookç›£è¦–
      - job_name: 'stripe-webhooks'
        scrape_interval: 10s
        metrics_path: '/webhook/metrics'
        static_configs:
          - targets: ['webhook-processor:8081']

      # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ç›£è¦–
      - job_name: 'postgres-exporter'
        scrape_interval: 30s
        static_configs:
          - targets: ['postgres-exporter:9187']

      # Redisç›£è¦–
      - job_name: 'redis-exporter'
        scrape_interval: 30s
        static_configs:
          - targets: ['redis-exporter:9121']

  payment_alerts.yml: |
    groups:
      - name: payment_system_alerts
        interval: 30s
        rules:
          # æ±ºæ¸ˆæˆåŠŸç‡ç›£è¦–ï¼ˆ99.5%é–¾å€¤ï¼‰
          - alert: PaymentSuccessRateLow
            expr: |
              (
                sum(rate(payment_transactions_total{status="success"}[5m])) /
                sum(rate(payment_transactions_total[5m]))
              ) * 100 < 99.5
            for: 2m
            labels:
              severity: critical
              team: team-d
              impact: "user-experience"
            annotations:
              summary: "æ±ºæ¸ˆæˆåŠŸç‡ãŒ99.5%ã‚’ä¸‹å›ã‚Šã¾ã—ãŸ"
              description: "éå»5åˆ†é–“ã®æ±ºæ¸ˆæˆåŠŸç‡ãŒ {{ $value }}% ã§ã™ã€‚ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±ºæ¸ˆã«å½±éŸ¿ãŒå‡ºã¦ã„ã¾ã™ã€‚"
              runbook_url: "https://docs.ai-subsidy.com/runbooks/payment-failure"
              user_impact: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ãŒæ±ºæ¸ˆã‚’å®Œäº†ã§ããªã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"

          # æ±ºæ¸ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ç›£è¦–ï¼ˆ3ç§’é–¾å€¤ï¼‰
          - alert: PaymentLatencyHigh
            expr: |
              histogram_quantile(0.99, 
                sum(rate(payment_request_duration_seconds_bucket[5m])) by (le)
              ) > 3
            for: 1m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
            annotations:
              summary: "æ±ºæ¸ˆå‡¦ç†ã®ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒé«˜ã™ãã¾ã™"
              description: "99%ile ãƒ¬ã‚¤ãƒ†ãƒ³ã‚·ãŒ {{ $value }}ç§’ ã§ã™ã€‚3ç§’ä»¥å†…ã®ç›®æ¨™ã‚’è¶…ãˆã¦ã„ã¾ã™ã€‚"
              user_impact: "ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®æ±ºæ¸ˆä½“é¨“ãŒä½ä¸‹ã—ã¦ã„ã¾ã™"

          # Webhookå‡¦ç†ç›£è¦–ï¼ˆ99.9%é–¾å€¤ï¼‰
          - alert: WebhookProcessingFailure
            expr: |
              (
                sum(rate(stripe_webhook_processed_total{status="success"}[5m])) /
                sum(rate(stripe_webhook_processed_total[5m]))
              ) * 100 < 99.9
            for: 1m
            labels:
              severity: critical
              team: team-d
              impact: "data-consistency"
            annotations:
              summary: "Stripe Webhookå‡¦ç†ã®æˆåŠŸç‡ãŒä½ä¸‹ã—ã¦ã„ã¾ã™"
              description: "Webhookå‡¦ç†æˆåŠŸç‡ãŒ {{ $value }}% ã§ã™ã€‚æ±ºæ¸ˆçŠ¶æ…‹ã®åŒæœŸã«å•é¡ŒãŒç™ºç”Ÿã—ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"
              user_impact: "æ±ºæ¸ˆå®Œäº†å¾Œã®å‡¦ç†ã«é…å»¶ãŒç™ºç”Ÿã™ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™"

          # æ±ºæ¸ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç›£è¦–
          - alert: PaymentTimeoutRate
            expr: |
              sum(rate(payment_transactions_total{status="timeout"}[5m])) /
              sum(rate(payment_transactions_total[5m])) * 100 > 1
            for: 2m
            labels:
              severity: warning
              team: team-d
              impact: "user-experience"
            annotations:
              summary: "æ±ºæ¸ˆã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ãŒé«˜ã™ãã¾ã™"
              description: "ã‚¿ã‚¤ãƒ ã‚¢ã‚¦ãƒˆç‡ãŒ {{ $value }}% ã§ã™ã€‚æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ã®å¿œç­”æ€§ã«å•é¡ŒãŒã‚ã‚Šã¾ã™ã€‚"

          # è‡ªå‹•ãƒªãƒˆãƒ©ã‚¤ç›£è¦–
          - alert: PaymentRetryRateHigh
            expr: |
              sum(rate(payment_retries_total[5m])) /
              sum(rate(payment_transactions_total[5m])) * 100 > 5
            for: 3m
            labels:
              severity: warning
              team: team-d
              impact: "system-stability"
            annotations:
              summary: "æ±ºæ¸ˆãƒªãƒˆãƒ©ã‚¤ç‡ãŒé«˜ã™ãã¾ã™"
              description: "ãƒªãƒˆãƒ©ã‚¤ç‡ãŒ {{ $value }}% ã§ã™ã€‚ã‚·ã‚¹ãƒ†ãƒ ã®å®‰å®šæ€§ã«æ‡¸å¿µãŒã‚ã‚Šã¾ã™ã€‚"

      - name: infrastructure_alerts
        interval: 60s
        rules:
          # ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šç›£è¦–
          - alert: DatabaseConnectionFailure
            expr: |
              up{job="postgres-exporter"} == 0
            for: 30s
            labels:
              severity: critical
              team: team-d
              impact: "system-availability"
            annotations:
              summary: "ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹æ¥ç¶šã«å¤±æ•—ã—ã¦ã„ã¾ã™"
              description: "PostgreSQLãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚"
              user_impact: "ã™ã¹ã¦ã®æ±ºæ¸ˆå‡¦ç†ãŒåœæ­¢ã—ã¾ã™"

          # Redisæ¥ç¶šç›£è¦–
          - alert: RedisConnectionFailure
            expr: |
              up{job="redis-exporter"} == 0
            for: 30s
            labels:
              severity: critical
              team: team-d
              impact: "session-management"
            annotations:
              summary: "Redisã‚­ãƒ£ãƒƒã‚·ãƒ¥æ¥ç¶šã«å¤±æ•—ã—ã¦ã„ã¾ã™"
              description: "Redisã‚¯ãƒ©ã‚¹ã‚¿ãƒ¼ã«æ¥ç¶šã§ãã¾ã›ã‚“ã€‚"
              user_impact: "ã‚»ãƒƒã‚·ãƒ§ãƒ³ç®¡ç†ã¨ã‚­ãƒ£ãƒƒã‚·ãƒ¥ãŒæ©Ÿèƒ½ã—ã¾ã›ã‚“"

          # ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡ç›£è¦–
          - alert: HighCPUUsage
            expr: |
              100 - (avg by (instance) (irate(node_cpu_seconds_total{mode="idle"}[5m])) * 100) > 80
            for: 5m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
            annotations:
              summary: "CPUä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: "CPUä½¿ç”¨ç‡ãŒ {{ $value }}% ã§ã™ã€‚"

          - alert: HighMemoryUsage
            expr: |
              (1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100 > 85
            for: 5m
            labels:
              severity: warning
              team: team-d
              impact: "performance"
            annotations:
              summary: "ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒé«˜ã™ãã¾ã™"
              description: "ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡ãŒ {{ $value }}% ã§ã™ã€‚"

  security_alerts.yml: |
    groups:
      - name: security_monitoring
        interval: 30s
        rules:
          # ä¸å¯©ãªæ±ºæ¸ˆãƒ‘ã‚¿ãƒ¼ãƒ³æ¤œçŸ¥
          - alert: SuspiciousPaymentPattern
            expr: |
              sum(rate(payment_transactions_total{amount_range="high"}[1m])) by (user_id) > 10
            for: 1m
            labels:
              severity: warning
              team: team-d
              impact: "security"
            annotations:
              summary: "ä¸å¯©ãªæ±ºæ¸ˆãƒ‘ã‚¿ãƒ¼ãƒ³ã‚’æ¤œçŸ¥ã—ã¾ã—ãŸ"
              description: "ãƒ¦ãƒ¼ã‚¶ãƒ¼{{ $labels.user_id }}ãŒçŸ­æ™‚é–“ã§å¤§é‡ã®é«˜é¡æ±ºæ¸ˆã‚’å®Ÿè¡Œã—ã¦ã„ã¾ã™ã€‚"

          # å¤±æ•—ãƒ­ã‚°ã‚¤ãƒ³è©¦è¡Œç›£è¦–
          - alert: HighFailedLoginRate
            expr: |
              sum(rate(auth_failed_attempts_total[5m])) by (ip_address) > 20
            for: 2m
            labels:
              severity: warning
              team: team-d
              impact: "security"
            annotations:
              summary: "ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—è©¦è¡ŒãŒå¤šã™ãã¾ã™"
              description: "IP {{ $labels.ip_address }} ã‹ã‚‰5åˆ†é–“ã§ {{ $value }} å›ã®ãƒ­ã‚°ã‚¤ãƒ³å¤±æ•—ãŒã‚ã‚Šã¾ã—ãŸã€‚"

          # WAFãƒ–ãƒ­ãƒƒã‚¯ç‡ç›£è¦–
          - alert: HighWAFBlockRate
            expr: |
              sum(rate(waf_blocked_requests_total[5m])) /
              sum(rate(waf_total_requests[5m])) * 100 > 10
            for: 3m
            labels:
              severity: warning
              team: team-d
              impact: "security"
            annotations:
              summary: "WAFãƒ–ãƒ­ãƒƒã‚¯ç‡ãŒé«˜ã™ãã¾ã™"
              description: "WAFã«ã‚ˆã‚‹ãƒ–ãƒ­ãƒƒã‚¯ç‡ãŒ {{ $value }}% ã§ã™ã€‚æ”»æ’ƒã‚’å—ã‘ã¦ã„ã‚‹å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚"

  grafana_dashboard.json: |
    {
      "dashboard": {
        "id": null,
        "title": "æ±ºæ¸ˆã‚·ã‚¹ãƒ†ãƒ ç›£è¦–ãƒ€ãƒƒã‚·ãƒ¥ãƒœãƒ¼ãƒ‰",
        "tags": ["payment", "team-d", "hybrid-billing"],
        "timezone": "Asia/Tokyo",
        "panels": [
          {
            "id": 1,
            "title": "æ±ºæ¸ˆæˆåŠŸç‡ (ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ )",
            "type": "stat",
            "targets": [
              {
                "expr": "sum(rate(payment_transactions_total{status=\"success\"}[1m])) / sum(rate(payment_transactions_total[1m])) * 100",
                "legendFormat": "æˆåŠŸç‡"
              }
            ],
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "steps": [
                    {"color": "red", "value": 0},
                    {"color": "yellow", "value": 95},
                    {"color": "green", "value": 99.5}
                  ]
                },
                "unit": "percent"
              }
            }
          },
          {
            "id": 2,
            "title": "æ±ºæ¸ˆãƒ¬ã‚¤ãƒ†ãƒ³ã‚·åˆ†å¸ƒ",
            "type": "heatmap",
            "targets": [
              {
                "expr": "sum(rate(payment_request_duration_seconds_bucket[5m])) by (le)",
                "legendFormat": "{{le}}"
              }
            ]
          },
          {
            "id": 3,
            "title": "1åˆ†ã‚ãŸã‚Šã®æ±ºæ¸ˆæ•°",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(payment_transactions_total[1m])) * 60",
                "legendFormat": "ç·æ±ºæ¸ˆæ•°/åˆ†"
              },
              {
                "expr": "sum(rate(payment_transactions_total{status=\"success\"}[1m])) * 60",
                "legendFormat": "æˆåŠŸæ±ºæ¸ˆæ•°/åˆ†"
              },
              {
                "expr": "sum(rate(payment_transactions_total{status=\"failed\"}[1m])) * 60",
                "legendFormat": "å¤±æ•—æ±ºæ¸ˆæ•°/åˆ†"
              }
            ]
          },
          {
            "id": 4,
            "title": "Webhookå‡¦ç†çŠ¶æ³",
            "type": "graph",
            "targets": [
              {
                "expr": "sum(rate(stripe_webhook_processed_total[5m]))",
                "legendFormat": "å‡¦ç†æ¸ˆWebhook/ç§’"
              },
              {
                "expr": "sum(stripe_webhook_queue_size)",
                "legendFormat": "å¾…æ©Ÿä¸­Webhookæ•°"
              }
            ]
          },
          {
            "id": 5,
            "title": "æ±ºæ¸ˆæ–¹æ³•åˆ¥æˆåŠŸç‡",
            "type": "piechart",
            "targets": [
              {
                "expr": "sum(rate(payment_transactions_total{status=\"success\"}[5m])) by (payment_method)",
                "legendFormat": "{{payment_method}}"
              }
            ]
          },
          {
            "id": 6,
            "title": "ã‚¤ãƒ³ãƒ•ãƒ©ãƒªã‚½ãƒ¼ã‚¹ä½¿ç”¨ç‡",
            "type": "graph",
            "targets": [
              {
                "expr": "100 - (avg(irate(node_cpu_seconds_total{mode=\"idle\"}[5m])) * 100)",
                "legendFormat": "CPUä½¿ç”¨ç‡"
              },
              {
                "expr": "(1 - (node_memory_MemAvailable_bytes / node_memory_MemTotal_bytes)) * 100",
                "legendFormat": "ãƒ¡ãƒ¢ãƒªä½¿ç”¨ç‡"
              }
            ]
          }
        ],
        "time": {
          "from": "now-1h",
          "to": "now"
        },
        "refresh": "10s"
      }
    }

---
# AlertManagerè¨­å®š
apiVersion: v1
kind: ConfigMap
metadata:
  name: alertmanager-config
  namespace: ai-subsidy-system
data:
  alertmanager.yml: |
    global:
      smtp_smarthost: 'smtp.gmail.com:587'
      smtp_from: 'alerts@ai-subsidy.com'
      smtp_auth_username: 'alerts@ai-subsidy.com'
      smtp_auth_password_file: '/etc/alertmanager/secrets/smtp_password'

    route:
      group_by: ['alertname', 'team']
      group_wait: 10s
      group_interval: 5m
      repeat_interval: 12h
      receiver: 'team-d-alerts'
      routes:
        - match:
            severity: critical
          receiver: 'critical-alerts'
          group_wait: 0s
          repeat_interval: 5m
        - match:
            team: team-d
          receiver: 'team-d-alerts'

    receivers:
      - name: 'team-d-alerts'
        email_configs:
          - to: 'team-d@ai-subsidy.com'
            subject: '[Team D] {{ .GroupLabels.alertname }} - {{ .Status }}'
            body: |
              {{ range .Alerts }}
              ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .Annotations.summary }}
              è©³ç´°: {{ .Annotations.description }}
              ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿: {{ .Annotations.user_impact }}
              ãƒ©ãƒ³ãƒ–ãƒƒã‚¯: {{ .Annotations.runbook_url }}
              ç™ºç”Ÿæ™‚åˆ»: {{ .StartsAt }}
              {{ end }}
        slack_configs:
          - api_url: 'https://hooks.slack.com/services/TEAM_D_WEBHOOK'
            channel: '#team-d-alerts'
            title: '{{ .GroupLabels.alertname }}'
            text: |
              {{ range .Alerts }}
              ğŸš¨ *{{ .Annotations.summary }}*
              {{ .Annotations.description }}
              
              *ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿:* {{ .Annotations.user_impact }}
              *å¯¾å¿œæ‰‹é †:* {{ .Annotations.runbook_url }}
              {{ end }}

      - name: 'critical-alerts'
        email_configs:
          - to: 'critical@ai-subsidy.com'
            subject: '[CRITICAL] {{ .GroupLabels.alertname }}'
            body: |
              ç·Šæ€¥ã‚¢ãƒ©ãƒ¼ãƒˆ: {{ .GroupLabels.alertname }}
              
              {{ range .Alerts }}
              è©³ç´°: {{ .Annotations.description }}
              ãƒ¦ãƒ¼ã‚¶ãƒ¼å½±éŸ¿: {{ .Annotations.user_impact }}
              å³åº§ã«å¯¾å¿œãŒå¿…è¦ã§ã™ã€‚
              {{ end }}
        pagerduty_configs:
          - service_key: 'PAGERDUTY_SERVICE_KEY'
            description: '{{ .GroupLabels.alertname }}: {{ .Annotations.summary }}'

    inhibit_rules:
      - source_match:
          severity: 'critical'
        target_match:
          severity: 'warning'
        equal: ['alertname', 'team']

---
# Prometheus ServiceMonitor for automatic discovery
apiVersion: monitoring.coreos.com/v1
kind: ServiceMonitor
metadata:
  name: payment-system-monitor
  namespace: ai-subsidy-system
  labels:
    team: team-d
    component: payment-monitoring
spec:
  selector:
    matchLabels:
      app: payment-service
  endpoints:
    - port: metrics
      interval: 15s
      path: /metrics
      scheme: http
    - port: webhook-metrics
      interval: 10s
      path: /webhook/metrics
      scheme: http